{{/*
    Template to publish an image exclusively for testing.
    By default this template is setup to publish to the 'gce-image-builder'
    project, the 'environment' variable can be used to publish to 'prod'.
    DeleteAfter is set to 180 days for all environments.
  */}}
{
  "Name": "test-image",
  {{$work_project := printf "%q" "gce-image-builder" -}}
  {{$endpoint := `"https://www.googleapis.com/compute/alpha/projects/"` -}}
  {{$delete_after := `"12h"` -}}
  {{if eq .environment "prod" -}}
  "WorkProject": {{$work_project}},
  "PublishProject": "bct-prod-images",
  "ComputeEndpoint": {{$endpoint}},
  "DeleteAfter": {{$delete_after}},
  {{- else -}}
  "WorkProject": {{$work_project}},
  "PublishProject": {{$work_project}},
  "ComputeEndpoint": {{$endpoint}},
  "DeleteAfter": {{$delete_after}},
  {{- end}}
  {{$time := trimPrefix .publish_version "v"}}
  "Images": [
    {
      "Prefix": "test-image",
      "Family": "test-image",
      "Description": "This is a test image built on {{$time}}.",
      "Licenses": [
        {{if (or (eq .environment "staging") (eq .environment "oslogin-staging")) -}}
        "projects/bct-staging-functional/global/licenses/debian-11-bullseye"
        {{- else -}}
        "projects/debian-cloud/global/licenses/debian-11-bullseye"
        {{- end}}
      ],
      "GuestOsFeatures": ["UEFI_COMPATIBLE", "VIRTIO_SCSI_MULTIQUEUE"]
    }
  ]
}