# What is Daisy?
Daisy is a solution for running complex, multi-step workflows on GCE.

[![GoDoc](https://godoc.org/github.com/GoogleCloudPlatform/compute-image-tools/daisy?status.svg)](https://godoc.org/github.com/GoogleCloudPlatform/compute-image-tools/daisy)

The current Daisy stepset includes support for creating/deleting GCE resources,
waiting for signals from GCE VMs, streaming GCE VM logs, uploading local files
to GCE and GCE VMs, and more.

For example, Daisy is used to create Google Official Guest OS images. The
workflow:
1. Creates a Debian 8 disk and another empty disk.
2. Creates and boots a VM with the two disks.
3. Waits for the VM to run a script which installs an OS on the empty disk.
4. Creates an image from the previously empty disk, now with an OS on it.
5. Automatically cleans up ephemeral workflow resources (the VM and disks).

Other use-case examples:
* Workflows for importing external physical or virtual disks to GCE.
* GCE environment deployment.
* Ad hoc GCE testing environment deployment and test running.

## Table of contents
  * [Setup](#setup)
  * [Running Daisy](#running-daisy)
  * [Workflow Config Overview](#workflow-config-overview)
    * [Sources](#sources)
    * [Steps](#steps)
      * [AttachDisks](#type-attachdisks)
      * [CreateDisks](#type-createdisks)
      * [CreateImages](#type-createimages)
      * [CreateInstances](#type-createinstances)
      * [CopyGCSObjects](#type-copygcsobjects)
      * [DeleteResources](#type-deleteresources)
      * [RunTests](#type-runtests)
      * [SubWorkflow](#type-subworkflow)
      * [WaitForInstancesSignal](#type-waitforinstancessignal)
    * [Dependencies](#dependencies)
    * [Vars](#vars)
      * [Autovars](#autovars)
  * [Glossary of Terms](#glossary-of-terms)
    * [GCE](#glossary-gce)
    * [GCP](#glossary-gcp)
    * [GCS](#glossary-gcs)
    * [Partial URL](#glossary-partialurl)
    * [Workflow](#glossary-workflow)

## Setup
Daisy is available for Windows, macOS, and Linux distros and is easily buildable
with the [Golang SDK](https://golang.org).
```shell
go get github.com/GoogleCloudPlatform/compute-image-tools/daisy
```
This will place the Daisy binary in $GOPATH/bin.

## Running Daisy
The basic use case for Daisy looks like:
```shell
daisy [path to workflow config file]
```

Many workflow config fields and variables can be overridden, for example:
```shell
daisy -project my-other-project \\
      -zone other-zone \\
      -variables foo=bar,baz=gaz \\
      wf.json
```

For additional information about Daisy flags, use `daisy -h`.

## Workflow Config Overview
A workflow is described by a JSON config file and contains information for the
workflow's steps, step dependencies, GCE/GCP/GCS credentials/configuration,
and file resources. The config has the following fields:

| Field Name | Type | Description |
|-|-|-|
| Name | string | The name of the workflow. Must be between 1-20 characters and match regex **[a-z]\([-a-z0-9]\*[a-z0-9])?**|
| Project | string | The GCE and GCS API enabled GCP project in which to run the workflow. |
| Zone | string | The GCE zone in which to run the workflow. |
| OAuthPath | string | A local path to JSON credentials for your Project. These credentials should have full GCE permission and read/write permission to GCSPath. If credentials are not provided here, Daisy will look for locally cached user credentials such as are generated by `gcloud init`. |
| GCSPath | string | Daisy will use this location as scratch space and for logging/output results. **NOTE**: If your workflow VMs need access to this location, your Project's default service account also needs read/write permissions.|
| Sources | map[string]string | A map of destination paths to local and GCS source paths. These sources will be uploaded to a subdirectory in GCSPath. The sources are referenced by their key name within the workflow config. See [Sources](#sources) below for more information. |
| Vars | map[string]string | A map of key value pairs. Vars are referenced by "${key}" within the workflow config. Caution should be taken to avoid conflicts with [autovars](#autovars). |
| Steps | map[string]Step | A map of step names to Steps. See [Steps](#steps) below for more information. |
| Dependencies | map[string]list(string) | A map of step names to a list of step names. This defines the dependencies for a step. Example: a step "foo" has dependencies on steps "bar" and "baz"; the map would include "foo": ["bar", "baz"]. |

Example workflow config:
```json
{
  "Name": "my-wf",
  "Project": "my-project",
  "Zone": "us-central1-f",
  "OAuthPath": "path/to/my/creds.json",
  "GCSPath": "gs://my-bucket/some/path/",
  "Sources": {
    "foo": "local/path/to/file1",
    "bar": "gs://gcs/path/to/file2"
  },
  "Vars": {
    "step1": "step1 name",
    "step2": "step2 name"
  },
  "Steps": {
    "${step1}": ...,
    "${step2}": ...,
    "step3 name": ...
  },
  "Dependencies": {
    "${step2}": ["${step1}"],
    "step3-name": ["${step2}"]
  }
}
```

### Sources

Daisy will upload any workflow sources to the sources directory in GCS
prior to running the workflow. The `Sources` field in a workflow
JSON file is a map of 'destination' to 'source' file. Sources can be a local
or GCS file or folder. Folders will be recursively copied into
destination.

In this example the local file `./path/to/startup.sh` will be copied to
`startup.sh` in the sources folder. Similarly the GCS file
`gs://my-bucket/some/path/install.py` will be copied to `install.py`.
The contents of paths referencing directories like
`./path/to/drivers_folder` and  `gs://my-bucket/my-files` will be
recursively copied to the directories `drivers` and `files` in GCS
respectively.

```json
"Sources": {
  "startup.sh": "./path/to/startup.sh",
  "install.py": "gs://my-bucket/some/path/install.py",
  "drivers": "./path/to/drivers_folder",
  "files": "gs://my-bucket/my-files"
}
```

### Steps
Step types are defined here:
https://godoc.org/github.com/GoogleCloudPlatform/compute-image-tools/daisy/workflow#Step

The `Steps` field is a named set of executable steps. It is a map of
a step's name to the step's type and configuration. Step names must begin with
a letter and only contain letters, numbers and hyphens.

For each individual 'step', you set one 'step type' and the type's
associated fields. You may optionally set a step timeout using
`Timeout`. `Timeout` uses [Golang's time.Duration string
format](https://golang.org/pkg/time/#Duration.String) and defaults
to "10m" (10 minutes).

This example has steps named "step 1" and "step 2". "step 1" has a type
of "<STEP 1 TYPE>" and a timeout of 2 hours. "step2" has a type of
"<STEP 2 TYPE>" and a timeout of 10 minutes, by default.
```json
"Steps": {
  "step1": {
    "<STEP 1 TYPE>": {
      ...
    },
    "Timeout": "2h"
  },
  "step2": {
    "<STEP 2 TYPE>": {
      ...
    }
  }
}
```

#### Type: AttachDisks
Not implemented yet.

#### Type: CreateDisks
Creates GCE disks. Each disk has the following fields:

| Field Name | Type | Description |
| - | - | - |
| Name | string | The name of the GCE disk. If ExactName is false, the **literal** disk name will have a generated suffix for the running instance of the workflow. |
| SourceImage | string | *Optional.* Creates a blank disk by default. Value can be 1) the Name of an image created in the workflow or 2) the [partial URL](#glossary-partialurl) of an existing GCE image. |
| SizeGB | string | *Optional if SourceImage is being used.* The size of the disk in GB. |
| Type | string | *Optional.* Defaults to "pd-standard". The type of disk. "pd-standard" or "pd-ssd". |
| Project | string | *Optional.* Project to create the disk in, overrides workflow Project. |
| Zone | string | *Optional.* Zone to create the disk in, overrides workflow Zone. |
| NoCleanup | bool | *Optional.* Defaults to false. Set this to true if you do not want Daisy to automatically delete this disk when the workflow terminates. |
| ExactName | bool | *Optional.* Defaults to false. Set this to true if you want Daisy to name this GCE disk exactly the same as Name. **Be advised**: this circumvents Daisy's efforts to prevent resource name collisions. |


Example: the first is a standard PD disk created from a source image, the second
is a blank PD SSD.
```json
"stepName": {
  "CreateDisks": [
    {
      "Name": "disk1",
      "SourceImage": "projects/debian-cloud/global/images/family/debian-8"
    },
    {
      "Name": "disk2",
      "SizeGb": "200",
      "Type": "pd-ssd"
    }
  ]
}
```

#### Type: CreateImages
Creates GCE images. Each image has the following fields:

| Field Name | Type | Description |
| - | - | - |
| Name | string | The name of the GCE image. If ExactName is false, the **literal** image name will have a generated suffix for the running instance of the workflow. |
| Project | string | *Optional.* Defaults to the workflow Project. The GCP project in which to create this image. |
| Family | string | *Optional.* The image family for the image. |
| Licenses | list(string) | *Optional.* A list of licenses to attach to the image. |
| GuestOsFeatures | list(string) | *Optional.* A list of features to enable on the Guest OS. |
| SourceDisk | string | *Mutually exclusive with SourceFile.* The disk from which to create the image. Value can be 1) the Name of a disk created in the workflow or 2) the [partial URL](#glossary-partialurl) of an existing GCE disk. |
| SourceFile | string | *Mutually exclusive with SourceDisk.* The file from which to create the image. Value can be 1) a Sources path or 2) a GCS path in the format "gs://..." |
| NoCleanup | bool | *Optional.* Defaults to false. Set this to true if you do not want Daisy to automatically delete this image when the workflow terminates. |
| ExactName | bool | *Optional.* Defaults to false. Set this to true if you want Daisy to name this GCE image exactly the same as Name. **Be advised**: this circumvents Daisy's efforts to prevent resource name collisions. |

This CreateImages example creates an image from a source disk.
```json
"stepName": {
  "CreateImages": [
    {
      "Name": "image1",
      "SourceDisk": "disk2"
    }
  ]
}
```

This CreateImages example creates an image from a file in GCS, it also
uses the NoCleanup flag to tell Daisy that this resource should exist
after workflow completion, and the ExactName flag to tell Daisy to not
use an generated name for the resource.
```json
"stepName": {
  "CreateImages": [
    {
      "Name": "image1",
      "SourceFile": "gs://my-bucket/image.tar.gz",
      "NoCleanup": true,
      "ExactName": true
    }
  ]
}
```

#### Type: CreateInstances
Creates GCE VM instances. Each VM has the following fields:

| Field Name | Type | Description |
| - | - | - |
| Name | string | The name of the GCE VM. If ExactName is false, the **literal** VM name will have a generated suffix for the running instance of the workflow. |
| AttachedDisks | list(string) | The disks to attach to this VM. The first disk will be used as the boot disk. These disks can be 1) Names from disks created previously in the workflow or 2) the [partial URL](#glossary-partialurl) of an existing GCE disk. |
| AttachedDisksRO | list(string) | *Optional.* The read only disks to attach to this VM. These disks can be 1) Names from disks created previously in the workflow or 2) the [partial URL](#glossary-partialurl) of an existing GCE disk. |
| MachineType | string | *Optional.* Defaults to "n1-standard-1". The VM [machine type](#https://cloud.google.com/compute/docs/machine-types). |
| StartupScript | string | *Optional.* The Sources path to the desired startup script. |
| Metadata | map[string]string | *Optional.* Metadata key-value pairs to set on the VM instance. |
| Scopes | list(string) | *Optional.* Defaults to https://www.googleapis.com/auth/devstorage.read_only. The workflow Project's default service account credentials scopes to grant to this VM. |
| Project | string | *Optional.* Project to create the instance in, overrides workflow Project. |
| Zone | string | *Optional.* Zone to create the instance in, overrides workflow Zone. |
| NoCleanup | bool | *Optional.* Defaults to false. Set this to true if you do not want Daisy to automatically delete this VM when the workflow terminates. |
| ExactName | bool | *Optional.* Defaults to false. Set this to true if you want Daisy to name this GCE VM exactly the same as Name. **Be advised**: this circumvents Daisy's efforts to prevent resource name collisions. |

This CreateInstances step example creates an instance with two attached
disks and uses the machine type n1-standard-4.
```json
"stepName": {
  "CreateInstances": [
    {
      "Name": "instance1",
      "AttachedDisks": ["disk1", "disk2"],
      "MachineType": "n1-standard-4"
    }
  ]
}
```

#### Type: CopyGCSObjects
Copies a GCS files from Source to Destination. Each copy has the following fields:

| Field Name | Type | Description |
| - | - | - |
| Source | string | Source path. |
| Destination | list(string) | Destination path. |

This CopyGCSObjects step example copies image.tar.gz from the Daisy OUTSPATH to gs://project2/my-image.tar.gz.
```json
"stepName": {
  "CopyGCSObjects": [
    {
      "Source": "${OUTSPATH}/image.tar.gz",
      "Destination": "gs://project/my-image.tar.gz"
    }
  ]
}
```

#### Type: DeleteResources
Deletes GCE resources (images, instances, disks). Resources are deleted in the
order: images, instances, disks.

| Field Name | Type | Description |
| - | - | - |
| Disks | list(string) | *Optional, but at least one of these fields must be used.* The list of disks to delete. Values can be 1) Names of disks created in this workflow or 2) the [partial URL](#glossary-partialurl) of an existing GCE disk. |
| Images | list(string) | *Optional, but at least one of these fields must be used.* The list of images to delete. Values can be 1) Names of images created in this workflow or 2) the [partial URL](#glossary-partialurl) of an existing GCE image. |
| Instances | list(string) | *Optional, but at least one of these fields must be used.* The list of disks to delete. Values can be 1) Names of VMs created in this workflow or 2) the [partial URL](#glossary-partialurl) of an existing GCE VM. |

This DeleteResources step example deletes an image, an instance, and two
disks.
```json
"stepName": {
  "DeleteResources": {
     "Images":["image1"],
     "Instances":["instance1"],
     "Disks":["disk1", "disk2"]
   }
}
```

#### Type: RunTests
Not implemented yet.

#### Type: SubWorkflow
Runs a Daisy workflow as a step. The subworkflow will have some fields
overwritten. For example, the subworkflow may specify a GCP Project "foo",
but the parent workflow is working in Project "bar". The subworkflow's Project
will be overwritten so that subworkflow is also running in "bar", the same as
the parent. The fields that get modified by the parent:
* Project (copied from parent)
* Zone (copied from parent)
* GCSPath (changed to a subdirectory in parent's GCSPath)
* OAuthPath (not used, parent workflow's credentials will be used)
* Vars (Vars can be passed in via the SubWorkflow step type Vars field)

SubWorkflow step type fields:

| Field Name | Type | Description |
| - | - | - |
| Path | string | The local path to the Daisy workflow file to run as a subworkflow. |
| Vars | map[string]string | *Optional.* Key-value pairs of variables to send to the subworkflow. Analogous to calling the subworkflow via the commandline with the `-variables foo=bar,baz=gaz` flag. |

This SubWorkflow step example uses a local workflow file and passes a var,
"foo", to the subworkflow.
```json
"stepName": {
  "SubWorkflow": {
    "Path": "./some_subworkflow.workflow",
    "Vars": {
        "foo": "bar"
    }
  }
}
```

#### Type: WaitForInstancesSignal
Waits for a signal from GCE VM instances. This step will fail if its Timeout
is reached or if a failure signal is received. The wait configuration for each
VM has the following fields:

| Field Name | Type | Description |
| - | - | - |
| Name | string | The Name or [partial URL](#glossary-partialurl) of the VM. |
| Interval | string ([Golang's time.Duration format](https://golang.org/pkg/time/#Duration.String)) | The signal polling interval. |
| Stopped | bool | Use the VM stopping as the signal. |
| SerialOutput | SerialOutput (see below) | Parse the serial port output for a signal. |

SerialOutput:

| Field Name | Type | Description |
| - | - | - |
| Port | int64 | The serial port number to listen to. GCE VMs have serial ports 1-4. |
| FailureMatch | string | *Optional, but this or SuccessMatch must be provided.* An expected string in case of a failure. |
| SuccessMatch | string | *Optional, but this or FailureMatch must be provided.* An expected string when the VM performed its task successfully. |

This example step waits for VM "foo" to stop and for a signal from VM "bar":
```json
"stepName": {
    "WaitForInstancesSignal": [
        {
            "Name": "foo",
            "Stopped": true
        },
        {
            "Name": "bar",
            "SerialOutput": {
                "Port": 1,
                "SuccessMatch": "this means I'm done! :)",
                "FailureMatch": "this means I failed... :("
            }
        }
    ]
}
```

### Dependencies

The Dependencies map describes the order in which workflow steps will run.
Steps without any dependencies will run immediately, otherwise a step will
only run once its dependencies have completed successfully.

In this example, step1 will run immediately as it has no dependencies, step2
and step3 will run after step1 completes, and step4 will run after step2 and
step3 complete.
```json
{
  "Steps": {
    "step1": {
      ...
    },
    "step2": {
      ...
    },
    "step3": {
      ...
    },
    "step4": {
      ...
    }
  },
  "Dependencies": {
    "step2": ["step1"],
    "step3": ["step1"],
    "step4": ["step2", "step3"]
  }
}
```

### Vars
Vars are a user-provided set of key-value pairs. Vars are used in string
substitutions in the rest of the workflow config using the syntax `${key}`.
Vars can be hardcoded into the workflow config or passed via the commandline.
Vars passed via the commandline will override the hardcoded Vars.

Example (incomplete) config:
```json
{
  "Name": "${var1}",
  "Zone": "${var2}",
  "Vars": {
    "var1": "foo-name",
    "var2": "foo-zone"
  }
}
```
When run, Name will be set to "foo-name" and Zone will be set to "foo-zone".
But, if the user calls Daisy with `daisy wf.json -variables var1=bar-name`,
then Name will be set to "bar-name" and not "foo-name".

#### Autovars
Autovars are used the same as Vars, but are automatically populated by Daisy
out of convenience. Here is the exhaustive list of autovars:

| Autovar key | Description |
| - | - |
| ID | The autogenerated random ID for the current workflow run. |
| NAME | The workflow's Name field. |
|	PROJECT | The workflow's Project field. |
|	ZONE | The workflow's Zone field. |
|	GCSPATH | The workflow's GCSPath field. |
|	DATE | The date of the current workflow run in YYYYMMDD. |
|	DATETIME | The date and time of the current workflow run in YYYYMMDDhhmmss. |
|	TIMESTAMP | The Unix epoch of the current workflow run. |
|	SCRATCHPATH | The scratch subdirectory of GCSPath that the running workflow instance uses. |
|	SOURCESPATH | Equivalent to ${SCRATCHPATH}/sources. |
|	LOGSPATH | Equivalent to ${SCRATCHPATH}/logs. |
|	OUTSPATH | Equivalent to ${SCRATCHPATH}/outs. |

## Glossary of Terms
Definitions:
* <a id="glossary-gce"></a>GCE: Google Compute Engine
* <a id="glossary-gcp"></a>GCP: Google Cloud Platform
* <a id="glossary-gcs"></a>GCS: Google Cloud Storage
* <a id="glossary-partialurl"></a>Partial URL: a URL for a GCE resource. Has the
form of "projects/PROJECT/zone/ZONE/RESOURCETYPE/RESOURCENAME"
* <a id="glossary-workflow"></a>Workflow: a graph of executable, blocking steps and their dependency relationships.
