

# What is Daisy?
Daisy is a solution for running complex, multi-step workflows on GCE.
https://godoc.org/github.com/GoogleCloudPlatform/compute-image-tools/daisy

The current Daisy stepset includes support for creating/deleting GCE resources,
waiting for signals from GCE VMs, streaming GCE VM logs, uploading local files
to GCE and GCE VMs, and more.

For example, Daisy is used to create Google Official Guest OS images. The
workflow:
1. Creates a Debian 8 disk and another empty disk.
2. Creates and boots a VM with the two disks.
3. Waits for the VM to run a script which installs an OS on the empty disk.
4. Creates an image from the previously empty disk, now with an OS on it.
5. Automatically cleans up ephemeral workflow resources (the VM and disks).

Other use-case examples:
* Workflows for importing external physical or virtual disks to GCE.
* GCE environment deployment.
* Ad hoc GCE testing environment deployment and test running.

## Table of contents
  * [Setup](#setup)
  * [Running Daisy](#running-daisy)
  * [Workflow Config Overview](#workflow-config-overview)
    * [Autovars](#autovars)
    * [Sources](#sources)
    * [Steps](#steps)
      * [AttachDisks](#type-attachdisks)
      * [CreateDisks](#type-createdisks)
      * [CreateImages](#type-createimages)
      * [CreateInstances](#type-createinstances)
      * [DeleteResources](#type-deleteresources)
      * [RunTests](#type-runtests)
      * [SubWorkflow](#type-subworkflow)
      * [WaitForInstancesSignal](#type-waitforinstancessignal)
      * [WaitForInstancesStopped](#type-waitforinstancesstopped)
  * [Dependency Map](#dependency-map)
  * [Glossary of Terms](#glossary-of-terms)
    * [GCE](#glossary-gce)
    * [GCP](#glossary-gcp)
    * [GCS](#glossary-gcs)
    * [Partial URL](#glossary-partialurl)
    * [Workflow](#glossary-workflow)

## Setup
Daisy is available for Windows, macOS, and Linux distros and is easily buildable
with the [Golang SDK](https://golang.org).
```shell
go get github.com/GoogleCloudPlatform/compute-image-tools/daisy
```
This will place the Daisy binary in $GOPATH/bin.

## Running Daisy
The basic use case for Daisy looks like:
```shell
daisy [path to workflow config file]
```

Many workflow config fields and variables can be overridden, for example:
```shell
daisy -project my-other-project \\
      -zone other-zone \\
      -variables foo=bar,baz=gaz \\
      wf.json
```

For additional information about Daisy flags, use `daisy -h`.

## Workflow Config Overview
A workflow config is written in JSON and contains the following fields:

| Field Name | Type | Description |
|-|-|-|
| Name | string | The name of the workflow. Must be between 1-20 characters and match regex **[a-z]\([-a-z0-9]\*[a-z0-9])?**|
| Project | string | The GCE and GCS API enabled GCP project in which to run the workflow. |
| Zone | string | The GCE zone in which to run the workflow. |
| OAuthPath | string | A local path to JSON credentials for your Project. These credentials should have full GCE permission and read/write permission to GCSPath. If credentials are not provided here, Daisy will look for locally cached user credentials such as are generated by `gcloud init`. |
| GCSPath | string | Daisy will use this location as scratch space and for logging/output results. **NOTE**: If your workflow VMs need access to this location, your Project's default service account also needs read/write permissions.|
| Sources | map[string]string | A map of destination paths to local and GCS source paths. These sources will be uploaded to a subdirectory in GCSPath. The sources are referenced by their key name within the workflow config. See [Sources](#sources) below for more information. |
| Vars | map[string]string | A map of key value pairs. Vars are referenced by "${key}" within the workflow config. Caution should be taken to avoid conflicts with [autovars](#autovars). |
| Steps | map[string]Step | A map of step names to Steps. See [Steps](#steps) below for more information. |
| Dependencies | map[string]list(string) | A map of step names to a list of step names. This defines the dependencies for a step. Example: a step "foo" has dependencies on steps "bar" and "baz"; the map would include "foo": ["bar", "baz"]. |

Example workflow config:
```json
{
  "Name": "my-wf",
  "Project": "my-project",
  "Zone": "us-central1-f",
  "OAuthPath": "path/to/my/creds.json",
  "GCSPath": "gs://my-bucket/some/path/",
  "Sources": {
    "foo": "local/path/to/file1",
    "bar": "gs://gcs/path/to/file2"
  },
  "Vars": {
    "step1": "step1 name",
    "step2": "step2 name"
  },
  "Steps": {
    "${step1}": ...,
    "${step2}": ...,
    "step3 name": ...
  },
  "Dependencies": {
    "${step2}": ["${step1}"],
    "step3-name": ["${step2}"]
  }
}
```

### Autovars
Autovars are used the same as Vars, but are automatically populated by Daisy out
of convenience. Here is the exhaustive list of autovars:

| Autovar key | Description |
| - | - |
| ID | The autogenerated random ID for the current workflow run. |
| NAME | The workflow's Name field. |
|	PROJECT | The workflow's Project field. |
|	ZONE | The workflow's Zone field. |
|	GCSPATH | The workflow's GCSPath field. |
|	DATE | The date of the current workflow run in YYYYMMDD. |
|	DATE | The date and time of the current workflow run in YYYYMMDDhhmmss. |
|	TIMESTAMP | The Unix epoch of the current workflow run. |
|	SCRATCHPATH | The scratch subdirectory of GCSPath that this workflow run uses. |
|	SOURCESPATH | Equivalent to ${SCRATCHPATH}/sources. |
|	LOGSPATH | Equivalent to ${SCRATCHPATH}/logs. |
|	OUTSPATH | Equivalent to ${SCRATCHPATH}/outs. |

### Sources

Daisy will upload any workflow sources to the sources directory in GCS
prior to running the workflow. The `Sources` field in a workflow
JSON file is a map of 'destination' to 'source' file. Sources can be a local
or GCS file or folder. Folders will be recursively copied into
destination.

In this example the local file `./path/to/startup.sh` will be copied to
`startup.sh` in the sources folder. Similarly the GCS file
`gs://my-bucket/some/path/install.py` will be copied to `install.py`.
The contents of paths referencing directories like
`./path/to/drivers_folder` and  `gs://my-bucket/my-files` will be
recursively copied to the directories `drivers` and `files` in GCS
respectively.

```json
"Sources": {
  "startup.sh": "./path/to/startup.sh",
  "install.py": "gs://my-bucket/some/path/install.py",
  "drivers": "./path/to/drivers_folder",
  "files": "gs://my-bucket/my-files"
}
```

### Steps
Step types are defined here:
https://godoc.org/github.com/GoogleCloudPlatform/compute-image-tools/daisy/workflow#Step

In a workflow file the `Steps` field is a mapping of step names to their
type descriptions. The name can be whatever you choose, it's how you
will reference the steps in the dependency map as well as how they will
show up in the logs. For each individual 'step' you set one 'step type'
along with any of its required fields.
```json
"Steps": {
  "step name 1": {
    "<STEP 1 TYPE>": {
      ...
    }
  },
  "step name 2": {
    "<STEP 2 TYPE>": {
      ...
    }
  }
}
```

#### Type: AttachDisks
Not implemented yet.

#### Type: CreateDisks
Creates GCE disks. Each disk has the following fields:

| Field Name | Type | Description |
| - | - | - |
| Name | string | The name of the GCE disk. If ExactName is false, the **literal** disk name will have a generated suffix for the running instance of the workflow. |
| SourceImage | string | *Optional.* Creates a blank disk by default. The source image can be one of two possibilities: the Name of an image created in the workflow or the [partial URL](#glossary-partialurl) of an existing GCE image. |
| SizeGB | string | *Optional if SourceImage is being used.* The size of the disk in GB. |
| Type | string | *Optional.* Defaults to "pd-standard". The type of disk. "pd-standard" or "pd-ssd". |
| NoCleanup | bool | *Optional.* Defaults to false. Set this to true if you do not want Daisy to automatically delete this disk when the workflow terminates. |
| ExactName | bool | *Optional.* Defaults to false. Set this to true if you want Daisy to name this GCE disk exactly the same as Name. **Be advised**: this circumvents Daisy's efforts to prevent resource name collisions. |


Example: the first is a standard PD disk created from a source image, the second
is a blank PD SSD.
```json
"create disks step": {
  "CreateDisks": [
    {
      "Name": "disk1",
      "SourceImage": "projects/debian-cloud/global/images/family/debian-8"
    },
    {
      "Name": "disk2",
      "SizeGb": "200",
      "Type": "pd-ssd"
    }
  ]
}
```

#### Type: CreateImages
Creates GCE images. Each image has the following fields:

| Field Name | Type | Description |
| - | - | - |
| Name | string | The name of the GCE image. If ExactName is false, the **literal** image name will have a generated suffix for the running instance of the workflow. |
| Project | string | *Optional.* Defaults to the workflow Project. The GCP project in which to create this image. |
| Family | string | *Optional.* The image family for the image. |
| Licenses | list(string) | *Optional.* A list of licenses to attach to the image. |
| GuestOsFeatures | list(string) | *Optional.* A list of features to enable on the Guest OS. |
| SourceDisk | string | *Mutually exclusive with SourceFile.* The disk from which to create the image. Can be one of two possibilities: the Name of a disk created in the workflow or the [partial URL](#glossary-partialurl) of an existing GCE disk. |
| SourceFile | string | *Mutually exclusive with SourceDisk.* The file from which to create the image. Can be one of two possibilities: a source path as defined in the workflow Sources or a GCS path in the format "gs://..." |
| NoCleanup | bool | *Optional.* Defaults to false. Set this to true if you do not want Daisy to automatically delete this image when the workflow terminates. |
| ExactName | bool | *Optional.* Defaults to false. Set this to true if you want Daisy to name this GCE image exactly the same as Name. **Be advised**: this circumvents Daisy's efforts to prevent resource name collisions. |

This CreateImages example creates an image from a source disk.
```json
"create image step": {
  "CreateImages": [
    {
      "Name": "image1",
      "SourceDisk": "disk2"
    }
  ]
}
```

This CreateImages example creates an image from a file in GCS, it also
uses the NoCleanup flag to tell Daisy that this resource should exist
after workflow completion, and the ExactName flag to tell Daisy to not
use an generated name for the resource.
```json
"create image step": {
  "CreateImages": [
    {
      "Name": "image1",
      "SourceFile": "gs://my-bucket/image.tar.gz",
      "NoCleanup": true,
      "ExactName": true
    }
  ]
}
```

#### Type: CreateInstances
Creates GCE instances.

This CreateInstances step example creates an instance with two attached
disks and uses the machine type n1-standard-4.
```json
"create instances step": {
  "createInstances": [
    {
      "name": "instance1",
      "attachedDisks": ["disk1", "disk2"],
      "machineType": "n1-standard-4"
    }
  ]
}
```

#### Type: DeleteResources
Deletes GCE resources (images, instances, disks). Any disks listed will
be deleted after any listed instances.

This DeleteResources step example deletes an image, an instance, and two
disks.
```json
"delete resources step": {
  "deleteResources": {
     "images":["image1"],
     "instances":["instance1"],
     "disks":["disk1", "disk2"]
   }
}
```

#### Type: RunTests
Not implemented yet.

#### Type: SubWorkflow
Runs a Daisy subworkflow.

This SubWorkflow step example uses a local workflow file.
```json
"sub workflow step": {
  "subWorkflow": {
    "path": "./some_subworkflow.workflow"
  }
}
```

#### Type: WaitForInstancesSignal
Not implemented yet.

#### Type: WaitForInstancesStopped
Waits for a set of instances to stop.

This WaitForInstancesStopped step example waits up to 1 hour for
'instance1' to stop.
```json
"wait for instances stopped step": {
  "timeout": "1h",
  "waitForInstancesStopped": ["instance1"]
},
```

## Dependency Map

The dependency map describes the order in which workflow steps will run.
Steps without any dependencies will run immediately, otherwise a step
will only run once its dependencies have completed successfully.

In this example step1 will run immediately as it has no dependencies,
step2 and step3 will run as soon as step1 completes, and step4 will run
as soon as both step2 and step3 complete.
```json
"steps": {
  "step1" {
    ...
  },
  "step2" {
    ...
  },
  "step3" {
    ...
  },
  "step4" {
    ...
  }
}
"dependencies": {
  "step2": ["step1"],
  "step3": ["step1"],
  "step4": ["step2", "step3"]
}
```

## Glossary of Terms
Definitions:
* <a id="glossary-gce"></a>GCE: Google Compute Engine
* <a id="glossary-gcp"></a>GCP: Google Cloud Platform
* <a id="glossary-gcs"></a>GCS: Google Cloud Storage
* <a id="glossary-partialurl"></a>Partial URL: a URL for a GCE resource. Has the
form of "projects/PROJECT/zone/ZONE/RESOURCETYPE/RESOURCENAME"
* <a id="glossary-workflow"></a>Workflow: a graph of executable, blocking steps and their dependency relationships.
