Definitions:
* GCP: Google Cloud Platform
* GCS: Google Cloud Storage
* GCE: Google Compute Engine
* Workflow: a graph of executable, blocking steps and their dependency
relationships

# What is Daisy?
Motivated by Google-internal image build workflows, Daisy is a solution for
running complex, multi-step procedures on and involving GCE.
https://godoc.org/github.com/GoogleCloudPlatform/compute-image-tools/daisy

The current Daisy stepset includes support for creating/deleting GCE resources,
waiting for signals from GCE VMs, streaming GCE VM logs, uploading local files
to GCE and GCE VMs, and more.

For example, Daisy is used to create Google Official Guest OS images. The
workflow:
1. Creates a Debian 8 disk and another empty disk.
2. Creates and boots a VM with the two disks.
3. Waits for the VM to run a script which installs an OS on the empty disk.
4. Creates an image from the previously empty disk, now with an OS on it.
5. Automatically cleans up ephemeral workflow resources (the VM and disks).

Other use-case examples:
* Image import workflows for images from other virtualization providers.
* GCE environment deployment
* Ad hoc GCE testing environment deployment and test running.

## Table of contents
  * [Setup](#setup)
  * [Running Daisy](#running-daisy)
  * [Workflow Config Overview](#workflow-config-overview)
    * [Autovars](#autovars)
    * [Sources](#sources)
    * [Steps](#steps)
      * [AttachDisks](#attachdisks)
      * [CreateDisks](#createdisks)
      * [CreateImages](#createimages)
      * [CreateInstances](#createinstances)
      * [DeleteResources](#deleteresources)
      * [RunTests](#runtests)
      * [SubWorkflow](#subworkflow)
      * [WaitForInstancesSignal](#waitforinstancessignal)
      * [WaitForInstancesStopped](#waitforinstancesstopped)
  * [Dependency Map](#dependency-map)

## Setup
Daisy is available for Windows, macOS, and Linux distros and is easily buildable
with the Golang SDK.
```shell
go get github.com/GoogleCloudPlatform/compute-image-tools/daisy
```
This will place the Daisy binary in $GOPATH/bin.

## Running Daisy
The basic use case for Daisy looks like:
```shell
daisy [path to workflow config file]
```

Many workflow config fields and variables can be overridden, for example:
```shell
daisy -project my-other-project \\
      -zone other-zone \\
      -variables foo=bar,baz=gaz \\
      wf.json
```

For additional information about Daisy flags, use `daisy -h`.

## Workflow Config Overview
A workflow config is written in JSON and contains the following fields:

| Field Name | Type | Description |
|-|-|-|
| Name | string | The name of the workflow. Must be between 1-20 characters and match regex **[a-z]\([-a-z0-9]\*[a-z0-9])?**|
| Project | string | The GCE and GCS API enabled GCP project in which to run the workflow. |
| Zone | string | The GCE zone in which to run the workflow. |
| OAuthPath | string | A local path to JSON credentials for your Project. These credentials should have full GCE permission and read/write permission to GCSPath. If credentials are not provided here, Daisy will look for locally cached user credentials such as are generated by `gcloud init`. |
| GCSPath | string | Daisy will use this location as scratch space and for logging/output results. **NOTE**: If your workflow VMs need access to this location, your Project's default service account also needs read/write permissions.|
| Sources | map[string]string | A map of destination paths to local and GCS source paths. These sources will be uploaded to a subdirectory in GCSPath. The sources are referenced by their key name within the workflow config. See [Sources](#sources) below for more information. |
| Vars | map[string]string | A map of key value pairs. Vars are referenced by "${key}" within the workflow config. Caution should be taken to avoid conflicts with [autovars](#autovars). |
| Steps | map[string]Step | A map of step names to Steps. See [Steps](#steps) below for more information. |
| Dependencies | map[string]list(string) | A map of step names to a list of step names. This defines the dependencies for a step. Example: a step "foo" has dependencies on steps "bar" and "baz"; the map would include "foo": ["bar", "baz"]. |

Example workflow config:
```json
{
  "Name": "my-wf",
  "Project": "my-project",
  "Zone": "us-central1-f",
  "OAuthPath": "path/to/my/creds.json",
  "GCSPath": "gs://my-bucket/some/path/",
  "Sources": {
    "foo": "local/path/to/file1",
    "bar": "gs://gcs/path/to/file2"
  },
  "Vars": {
    "step1": "step1 name",
    "step2": "step2 name"
  },
  "Steps": {
    "${step1}": ...,
    "${step2}": ...,
    "step3 name": ...
  },
  "Dependencies": {
    "${step2}": ["${step1}"],
    "step3-name": ["${step2}"]
  }
}
```

### Autovars
Autovars are used the same as Vars, but are automatically populated by Daisy out
of convenience. Here is the exhaustive list of autovars:

| Autovar key | Description |
| - | - |
| ID | The autogenerated random ID for the current workflow run. |
| NAME | The workflow's Name field. |
|	PROJECT | The workflow's Project field. |
|	ZONE | The workflow's Zone field. |
|	GCSPATH | The workflow's GCSPath field. |
|	DATE | The date of the current workflow run in YYYYMMDD. |
|	DATE | The date and time of the current workflow run in YYYYMMDDhhmmss. |
|	TIMESTAMP | The Unix epoch of the current workflow run. |
|	SCRATCHPATH | The scratch subdirectory of GCSPath that this workflow run uses. |
|	SOURCESPATH | Equivalent to ${SCRATCHPATH}/sources. |
|	LOGSPATH | Equivalent to ${SCRATCHPATH}/logs. |
|	OUTSPATH | Equivalent to ${SCRATCHPATH}/outs. |

### Sources

Daisy will upload any workflow sources to the sources directory in GCS
prior to running the workflow. The `Sources` field in a workflow
JSON file is a map of 'destination' to 'source' file. Sources can be a local
or GCS file or folder. Folders will be recursively copied into
destination.

In this example the local file `./path/to/startup.sh` will be copied to
`startup.sh` in the sources folder. Similarly the GCS file
`gs://my-bucket/some/path/install.py` will be copied to `install.py`.
The contents of paths referencing directories like
`./path/to/drivers_folder` and  `gs://my-bucket/my-files` will be
recursively copied to the directories `drivers` and `files` in GCS
respectively.

```json
"Sources": {
  "startup.sh": "./path/to/startup.sh",
  "install.py": "gs://my-bucket/some/path/install.py",
  "drivers": "./path/to/drivers_folder",
  "files": "gs://my-bucket/my-files"
}
```

### Steps
Step types are defined here:
https://godoc.org/github.com/GoogleCloudPlatform/compute-image-tools/daisy/workflow#Step

In a workflow file the `Steps` field is a mapping of step names to their
type descriptions. The name can be whatever you choose, it's how you
will reference the steps in the dependency map as well as how they will
show up in the logs. For each individual 'step' you set one 'step type'
along with any of its required fields.
```json
"Steps": {
  "step name 1": {
    "stepType": {
      ...
    }
  },
  "step name 2": {
    "stepType": {
      ...
    }
  }
}
```

#### AttachDisks
Not implemented yet.

#### CreateDisks
Creates GCE disks.

This CreateDisks step example creates two disks: the first is a standard
PD disk created from a source image, the second is blank PD SSD.
```json
"create disks step": {
  "createDisks": [
    {
      "name": "disk1",
      "sourceImage": "projects/debian-cloud/global/images/family/debian-8"
    },
    {
      "name": "disk2",
      "sizeGb": "200",
      "type": "pd-ssd"
    }
  ]
}
```

#### CreateImages
Creates GCE images.

This CreateImages example creates an image from a source disk.
```json
"create image step": {
  "createImages": [
    {
      "name": "image1",
      "sourceDisk": "disk2"
    }
  ]
}
```

This CreateImages example creates an image from a file in GCS, it also
uses the no_cleanup flag to tell Daisy that this resource should exist
after workflow completion, and the exact_name flag to tell Daisy to not
use an generated name for the resource.
```json
"create image step": {
  "createImages": [
    {
      "name": "image1",
      "sourceFile": "gs://my-bucket/image.tar.gz",
      "noCleanup": true,
      "exactName": true
    }
  ]
}
```

#### CreateInstances
Creates GCE instances.

This CreateInstances step example creates an instance with two attached
disks and uses the machine type n1-standard-4.
```json
"create instances step": {
  "createInstances": [
    {
      "name": "instance1",
      "attachedDisks": ["disk1", "disk2"],
      "machineType": "n1-standard-4"
    }
  ]
}
```

#### DeleteResources
Deletes GCE resources (images, instances, disks). Any disks listed will
be deleted after any listed instances.

This DeleteResources step example deletes an image, an instance, and two
disks.
```json
"delete resources step": {
  "deleteResources": {
     "images":["image1"],
     "instances":["instance1"],
     "disks":["disk1", "disk2"]
   }
}
```

#### RunTests
Not implemented yet.

#### SubWorkflow
Runs a Daisy subworkflow.

This SubWorkflow step example uses a local workflow file.
```json
"sub workflow step": {
  "subWorkflow": {
    "path": "./some_subworkflow.workflow"
  }
}
```

#### WaitForInstancesSignal
Not implemented yet.

#### WaitForInstancesStopped
Waits for a set of instances to stop.

This WaitForInstancesStopped step example waits up to 1 hour for
'instance1' to stop.
```json
"wait for instances stopped step": {
  "timeout": "1h",
  "waitForInstancesStopped": ["instance1"]
},
```

## Dependency Map

The dependency map describes the order in which workflow steps will run.
Steps without any dependencies will run immediately, otherwise a step
will only run once its dependencies have completed successfully.

In this example step1 will run immediately as it has no dependencies,
step2 and step3 will run as soon as step1 completes, and step4 will run
as soon as both step2 and step3 complete.
```json
"steps": {
  "step1" {
    ...
  },
  "step2" {
    ...
  },
  "step3" {
    ...
  },
  "step4" {
    ...
  }
}
"dependencies": {
  "step2": ["step1"],
  "step3": ["step1"],
  "step4": ["step2", "step3"]
}
```
