{
  "Name": "Run-OsConfig-integration-tests",
  "Vars": {
    "base-repo": {
      "Required": true,
      "Description": "Base GitHub repo"
    },
    "branch": {
      "Required": true,
      "Description": "Branch to use"
    },
    "test-project-id": {
      "Required": true,
      "Description": "project where the end to end test needs to run"
    },
    "test-zone": {
      "Required": true,
      "Description": "project zone where the end to end test needs to run"
    },
    "test-suite-filter": {
      "Required": false,
      "Description": "filters for test suite"
    },
    "test-case-filter": {
      "Required": false,
      "Description": "filters for test case"
    }
  },
  "Sources": {
    "build_osconfig_agent_test.sh": "./build_osconfig_agent_test.sh"
  },
  "Steps": {
    "setup-disks": {
      "CreateDisks": [
        {
          "Name": "disk-build",
          "SourceImage": "projects/debian-cloud/global/images/family/debian-9",
          "Type": "pd-ssd"
        }
      ]
    },
    "build-and-run-test": {
      "CreateInstances": [
        {
          "Name": "inst-build-and-run-osconfig-tests",
          "Disks": [
            {
              "Source": "disk-build"
            }
          ],
          "StartupScript": "build_osconfig_agent_test.sh",
          "MachineType": "n1-standard-4",
          "Metadata": {
            "base-repo": "${base-repo}",
            "branch": "${branch}",
            "test-project-id": "${test-project-id}",
            "test-zone": "${test-zone}",
            "test-suite-filter": "${test-suite-filter}",
            "test-case-filter": "${test-case-filter}"
          },
          "Scopes": [
            "https://www.googleapis.com/auth/devstorage.read_write",
            "https://www.googleapis.com/auth/cloud-platform"
          ]
        }
      ]
    },
    "wait-test-run": {
      "Timeout": "30m",
      "WaitForInstancesSignal": [
        {
          "Name": "inst-build-and-run-osconfig-tests",
          "SerialOutput": {
            "Port": 1,
            "FailureMatch": "BuildFailed:",
            "SuccessMatch": "BuildSuccess:",
            "StatusMatch": "BuildStatus:"
          }
        }
      ]
    },
    "cleanup-test-runner": {
      "DeleteResources": {
        "Instances": [
          "inst-build-and-run-osconfig-tests"
        ]
      }
    }
  },
  "Dependencies": {
    "build-and-run-test": [
      "setup-disks"
    ],
    "wait-test-run": [
      "build-and-run-test"
    ],
    "cleanup-test-runner": [
      "wait-test-run"
    ]
  }
}